<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="./vendor/css/bootstrap.min.css" rel="stylesheet">
    <script src="./vendor/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <title>Dashboard - Universidad Santa Maria</title>
    <link rel="stylesheet" href="./css/profesores.css">
</head>

<body>
    <div class="dashboard-container">
        <!-- Menú lateral integrado directamente (antes era un iframe) -->
        <div id="sidebar" class="sidebar">
            <div class="centered-bars" id="toggleBtn">
                <img src="./img/bars-solid.svg" width="20px" alt="Bars Icon" class="white-icon">
            </div>
            <div class="sidebar-header">
                Menú
            </div>
            <div class="sidebar-content">
                <a href="./dashboard.html"><i class="fas fa-home"></i> <span>Inicio</span></a>
                <a href="#"><i class="fas fa-user"></i> <span>Perfil</span></a>
                <a href="#"><i class="fas fa-cog"></i> <span>Configuración</span></a>
                <a href="#"><i class="fas fa-envelope"></i> <span>Contacto</span></a>
                <a href="#"><i class="fas fa-sign-out-alt"></i> <span>Salir</span></a>
            </div>
        </div>
        <div id="content">
            <div class="main-content">
                <div class="header-section">
                    <div class="header-text">
                        <h1>Universidad Santa Maria</h1>
                        <p>Sistema de Mobiliario y Agendamientos de Salones</p>
                    </div>
                    <div class="header-logo">
                        <img src="./img/logousm.png" alt="logo usm" style="width: 120px; height: auto;">
                    </div>
                    <img src="./img/iconouser.png" alt="Usuario">
                </div>
                <h4 id="nombreusuario">¡Bienvenido!</h4>
                <span style="font: size 30%; ;"> Estás en el Área de Profesores</span>
                <br>
                <!-- NUEVO CONTENIDO -->
                <div class="search-container">
                    <div class="search-box">
                        <!-- barra de busqueda -->
                        <div class="bg-light">
                            <div class="container py-5">
                                <div class="search-wrapper">
                                    <div class="search-box">
                                        <input type="text" class="search-input form-control"
                                            placeholder="Search anything...">
                                        <i class="fas fa-search search-icon"></i>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tabla de muestra de los profesores -->
                        <table class="table align-middle mb-0 bg-white">
                            <thead class="bg-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Titulo</th>
                                    <th>Status</th>
                                    <th>Cargo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <!--Aqui va es la llamada a BD-->
                    <div class="vertical-buttons">
                        <div class="action-button">
                            <a href="profesores.html" style="color: white; text-decoration: none;">
                                <span>Ver todos</span>
                                <i class="fas fa-list"></i>
                            </a>
                        </div>
                        <div class="action-button" data-bs-toggle="modal" data-bs-target="#nuevoRegistroModal">
                            <span>Nuevo registro</span>
                            <i class="fas fa-plus"></i>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para registrar profesor -->
    <div class="modal fade" id="nuevoRegistroModal" tabindex="-1" aria-labelledby="nuevoRegistroModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nuevoRegistroModalLabel">Gestión de Profesores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="profesorForm">
                        <div class="form-group">
                            <label for="nombreApellido">Nombre y Apellido</label>
                            <input type="text" id="nombreApellido" class="form-control" placeholder="Nombre y Apellido"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="telefono">Teléfono</label>
                            <input type="tel" id="telefono" class="form-control" placeholder="Teléfono" required>
                        </div>
                        <div class="form-group">
                            <label for="cedula">Cédula</label>
                            <input type="text" id="cedula" class="form-control" placeholder="Cédula" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Correo Electrónico</label>
                            <input type="email" id="email" class="form-control" placeholder="Correo Electrónico"
                                required>
                        </div>

                        <br>
                        <div style="text-align: center;">
                            <button type="submit" id="submitButton" class="btn btn-primary">Añadir</button>
                        </div>
                        <div id="alertContainer" style="display: none;" class="alert" role="alert"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para editar profesor -->
    <div class="modal fade" id="editarProfesorModal" tabindex="-1" aria-labelledby="editarProfesorModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editarProfesorModalLabel">Editar Profesor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="profesorId">
                    <div class="mb-3">
                        <label for="editarNombreApellido" class="form-label">Nombre y Apellido</label>
                        <input type="text" class="form-control" id="editarNombreApellido">
                    </div>
                    <div class="mb-3">
                        <label for="editarTelefono" class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="editarTelefono">
                    </div>
                    <div class="mb-3">
                        <label for="editarCedula" class="form-label">Cédula</label>
                        <input type="text" class="form-control" id="editarCedula">
                    </div>
                    <div class="mb-3">
                        <label for="editarEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editarEmail">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
    try {
        const responseUsuario = await fetch('/usuario');
        if (!responseUsuario.ok) throw new Error('No autorizado');
        const usuario = await responseUsuario.json();
        document.getElementById("nombreusuario").textContent = `¡Bienvenido, Prof. ${usuario.nombre}!`;
    } catch (error) {
        console.error('Error obteniendo el usuario:', error);
        document.getElementById("nombreusuario").textContent = "¡Bienvenido!";
    }
});

/*Funcion para enviar al server (insertar profesores)*/
document.getElementById("profesorForm").addEventListener("submit", async function (event) {
    event.preventDefault(); // Evita el envío por defecto del formulario

    const formData = {
        nombreApellido: document.getElementById("nombreApellido").value,
        telefono: document.getElementById("telefono").value,
        cedula: document.getElementById("cedula").value,
        email: document.getElementById("email").value,
    };

    try {
        const response = await fetch('/registrarprofesor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        });

        if (response.ok) {
            alertContainer.style.display = "block";
            alertContainer.className = "alert alert-success";
            alertContainer.textContent = "Profesor registrado exitosamente";
            document.getElementById("profesorForm").reset(); // Limpia el formulario
        } else {
            alertContainer.style.display = "block";
            alertContainer.className = "alert alert-danger";
            alertContainer.textContent = "Error al registrar el profesor";
        }
    } catch (error) {
        console.error("Error al enviar los datos:", error);
        alertContainer.style.display = "block";
        alertContainer.className = "alert alert-danger";
        alertContainer.textContent = "Error al registrar el profesor";
    }
});

/*cargar profesores*/
document.addEventListener("DOMContentLoaded", async function () {
    const tbody = document.querySelector("tbody");
    const searchInput = document.querySelector(".search-input");

    try {
        const responseProfesores = await fetch('/registrarprofesor');
        if (!responseProfesores.ok) throw new Error('Error al obtener los profesores');

        const profesores = await responseProfesores.json();

        tbody.innerHTML = ''; // Limpia el contenido del tbody

        profesores.forEach(profesor => {
            const row = `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="https://mdbootstrap.com/img/new/avatars/8.jpg" alt=""
                                 style="width: 45px; height: 45px" class="rounded-circle" />
                            <div class="ms-3">
                                <p class="fw-bold mb-1">${profesor.nbProfesor}</p>
                                <p class="text-muted mb-0">${profesor.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <p class="fw-normal mb-1">N/A</p>
                        <p class="text-muted mb-0">Profesor</p>
                    </td>
                    <td>
                        <span class="badge badge-success rounded-pill d-inline">Active</span>
                    </td>
                    <td>Profesor</td>
                    <td>
                        <button type="button" class="btn btn-secondary btn-sm btn-rounded editar-btn" data-id="${profesor.idProfesor}">
                            Editar
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // Agregar funcionalidad de búsqueda después de cargar las filas
        searchInput.addEventListener("input", function () {
            const searchText = searchInput.value.toLowerCase();
            const tableRows = document.querySelectorAll("table tbody tr");

            tableRows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(searchText)) {
                    row.style.display = ""; // Muestra la fila
                } else {
                    row.style.display = "none"; // Oculta la fila
                }
            });
        });

       

    } catch (error) {
        console.error('Error al cargar los profesores:', error);
    }
});
 // Inicializar el modal fuera del listener de clic
 const editarProfesorModalElement = document.getElementById("editarProfesorModal");
        const editarModal = new bootstrap.Modal(editarProfesorModalElement);

        // Agregar eventos a los botones "Editar"
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("editar-btn")) {
                console.log("Se hizo clic en el botón Editar");

                const profesorId = event.target.getAttribute("data-id");
                const profesor = profesores.find(p => p.id == profesorId);

                if (profesor) {
                    // Cargar datos en el modal
                    document.getElementById("profesorId").value = profesor.id;
                    document.getElementById("editarNombreApellido").value = profesor.nbProfesor;
                    document.getElementById("editarEmail").value = profesor.email;

                    // Abrir el modal usando la instancia pre-existente
                    editarModal.show();
                }
            }
        });
// Enviar datos modificados al servidor
document.getElementById("editarProfesorForm").addEventListener("submit", async function (event) {
    event.preventDefault();

    const profesorId = document.getElementById("profesorId").value;
    const formData = {
        nombreApellido: document.getElementById("editarNombreApellido").value,
        telefono: document.getElementById("editarTelefono").value,
        cedula: document.getElementById("editarCedula").value,
        email: document.getElementById("editarEmail").value,
    };

    try {
        const response = await fetch(`/editarprofesor/${profesorId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        });

        if (response.ok) {
            alert("Profesor actualizado exitosamente");
            location.reload(); // Recargar la página para reflejar los cambios
        } else {
            alert("Error al actualizar el profesor");
        }
    } catch (error) {
        console.error("Error al enviar los datos:", error);
        alert("Error al actualizar el profesor");
    }
});
    </script>

</body>

</html>